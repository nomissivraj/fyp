<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Voice Developer</title>
        
        <link rel="stylesheet" type="text/css" href="node_modules/codemirror/lib/codemirror.css">
        <link rel="stylesheet" type="text/css" href="node_modules/codemirror/theme/lucario.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script src="node_modules/codemirror/lib/codemirror.js"></script>
        <script src="node_modules/codemirror/mode/xml/xml.js"></script>
        <script src="node_modules/codemirror/mode/css/css.js"></script>
        <script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
        <script src="node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
        <script src="node_modules/codemirror/addon/edit/matchtags.js"></script>
        <script src="node_modules/codemirror/addon/edit/closetag.js"></script>
        <script src="node_modules/codemirror/addon/fold/xml-fold.js"></script>
        <script src="scripts/funcs.js"></script>
        <script src="scripts/stt.js"></script>
        <script src="scripts/stc.js"></script>

    </head>
    <body class="text-editor">
        <header class="app-header">
            <div class="app-toolbar">
                <div class="app-toolbar__icon">
                    <img src="img/app-icon-64x64.png" alt="Voice Developer Icon">
                </div>
                <div class="app-toolbar__menu">
                    <ul id="menu">
                        <li class="dropdown__item">
                            <button class="dropdown__btn dropdown__btn--file">File</button>
                            <div class="dropdown__menu" id="dropdown__menu--file"  style="display: none">
                                <ul class="submenu">
                                    <li>
                                        <button id="newpagebtn" class="submenu__btn">
                                            <span class="submenu__item-title">New Page</span>
                                        </button>
                                    </li>
                                    <li>
                                            <button id="deletepagebtn" class="submenu__btn">
                                                <span class="submenu__item-title">Delete Page</span>
                                            </button>
                                        </li>
                                    <hr>
                                    <li>
                                        <button id="savebtn" class="submenu__btn">
                                            <span class="submenu__item-title">Save</span>
                                            <span class="submenu__item-shortcut">Shortcut</span>
                                        </button>
                                    </li>
                                    <hr>
                                    <li>
                                        <button id="exitbtn" class="submenu__btn">
                                            <span class="submenu__item-title">Exit</span>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="dropdown__item">
                            <button class="dropdown__btn dropdown__btn--edit">Edit</button>
                            <div class="dropdown__menu" id="dropdown__menu--edit" style="display: none">
                                <ul class="submenu">
                                    <li>
                                        <button id="undobtn" class="submenu__btn">
                                            <span class="submenu__item-title">Undo</span>
                                            <span class="submenu__item-shortcut">Ctrl+Z</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="redobtn" class="submenu__btn">
                                            <span class="submenu__item-title">Redo</span>
                                            <span class="submenu__item-shortcut">Ctrl+Shift+Z</span>
                                        </button>
                                    </li>
                                    <hr>
                                    <li>
                                        <button id="cutbtn" class="submenu__btn">
                                            <span class="submenu__item-title">Cut</span>
                                            <span class="submenu__item-shortcut">Ctrl+X</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="copybtn" class="submenu__btn">
                                            <span class="submenu__item-title">Copy</span>
                                            <span class="submenu__item-shortcut">Ctrl+C</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="pastebtn" class="submenu__btn">
                                            <span class="submenu__item-title">Paste</span>
                                            <span class="submenu__item-shortcut">Ctrl+P</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="deletebtn" class="submenu__btn">
                                            <span class="submenu__item-title">Delete</span>
                                        </button>
                                    </li>
                                    <hr>
                                    <li>
                                        <button id="enterbtn" class="submenu__btn">
                                            <span class="submenu__item-title">Enter</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="tabbtn" class="submenu__btn">
                                            <span class="submenu__item-title">Tab</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="spacebtn" class="submenu__btn">
                                            <span class="submenu__item-title">Space</span>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="dropdown__item">
                            <button class="dropdown__btn dropdown__btn--preview">Preview</button>
                            <div class="dropdown__menu" id="dropdown__menu--preview"  style="display: none">
                                <ul class="submenu">
                                    <li>
                                        <button id="previewbtn" class="submenu__btn">
                                            <span class="submenu__item-title">Open in Browser</span>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="dropdown__item">
                            <button class="dropdown__btn dropdown__btn--tags">Tags</button>
                            <div class="dropdown__menu" id="dropdown__menu--tags"  style="display: none">
                                <ul class="submenu">
                                    <li>
                                        <button id="heading1btn" class="submenu__btn">
                                            <span class="submenu__item-title">Heading 1</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="heading2btn" class="submenu__btn">
                                            <span class="submenu__item-title">Heading 2</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="heading3btn" class="submenu__btn">
                                            <span class="submenu__item-title">Heading 3</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="heading4btn" class="submenu__btn">
                                            <span class="submenu__item-title">Heading 4</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="heading5btn" class="submenu__btn">
                                            <span class="submenu__item-title">Heading 5</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button id="heading6btn" class="submenu__btn">
                                            <span class="submenu__item-title">Heading 6</span>
                                        </button>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                    
                </div>
                <div class="app-toolbar__title">
                    <span>Voice Developer</span>
                </div>
                <div class="app-toolbar__options">
                    <div id="min-btn" class="options__minimise">
                        <img src="img/app-min.svg" width="12px" alt="minimise window icon">
                    </div>
                    <div id="max-btn" class="options__maximise">
                        <img src="img/app-max.svg" width="12px" alt="maximise window icon">
                    </div>
                    <div id="restore-btn" class="options__restore">
                        <img src="img/app-restore.svg" width="12px" alt="restore window icon">
                    </div>
                    <div id="close-btn" class="options__close">
                        <img src="img/app-close.svg" width="12px" alt="close window icon">
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div class="tab-bar__container"> 
                <div class="tab-bar">
                    <ul class="tabs">
                        
                    </ul>
                </div>
            </div>
            <div id="pages-container">

            </div>

            <div id="newpageform__container" class="dialogue" style="display:none">
                <h1>New Page</h1>
                <form id="newpage__form">
                    <input type="text" id="page-to-create" placeholder="Page name" required>
                    <button type="button" onclick="resetForms('newpageform__container')">Cancel</button>
                    <button type="submit" class="positive">Create</button>
                </form>
            </div>

            <div id="deletepageform__container" class="dialogue" style="display:none">
                <h1>Delete Page</h1>
                <form id="deletepage__form">
                    <input type="text" id="page-to-delete" placeholder="Page name" required>
                    <button type="button" onclick="resetForms('deletepageform__container')">Cancel</button>
                    <button type="submit" class="negative">Delete</button>
                </form>
            </div>

            <button type="button" id="dictate-btn"></button>
        </main>
        
    </body>
    <script>
        require('./scripts/renderer.js');
        const electron = require('electron');
        const {ipcRenderer} = electron;
        const remote = require('electron').remote;
        const app = remote.app;
        const path = require('path');
        const fs = require('file-system');
        const savesPath = path.join(app.getPath('documents'),'Voice Developer Projects','/saves/');
        const shell = require('electron').shell;
        ipcRenderer.send('ready:text-window');
        process.env['ELECTRON_DISABLE_SECURITY_WARNINGS'] = 'true';
        
        //Process Forms
        const newPageForm = document.getElementById('newpage__form');
        newPageForm.addEventListener('submit', newPage);

        const deletePageForm = document.getElementById('deletepage__form');
        deletePageForm.addEventListener('submit', deletePage);

        function newPage(e) {
            e.preventDefault();
            let pages = curProjectDetails.pages;
            let pageName = document.querySelectorAll('#page-to-create')[0].value;
            console.log(pageName);
            let projectDetails = {
                'name' : currentProject,
                'mode' : curProjectDetails.mode,
                'layout' : curProjectDetails.layout,
                'pages' : pages,
                'newpage' : pageName
            }
            if (pages.length > 0) {
                if (pages.indexOf(pageName) > -1) {
                    alert('A project with that name already exists, try again');
                    return
                } else {
                    ipcRenderer.send('create:page', projectDetails)
                    toggleDisplay('newpage__container');
                }
            } else if (pages.length === 0) {
                ipcRenderer.send('create:page', projectDetails);
                toggleDisplay('newpage__container');
            }
        }

        function deletePage(e) {
            e.preventDefault();
            const pageName = document.getElementById('page-to-delete').value;
            let projectDetails = {
                'name' : currentProject,
                'mode' : curProjectDetails.mode,
                'layout' : curProjectDetails.layout,
                'pages' : curProjectDetails.pages,
                'deletepage' : pageName
            }
            console.log(pageName)
            if (curProjectDetails.pages.indexOf(pageName) === -1) {
                alert("No existing page with the name '"+pageName+"' please try again.")
                log.error('Page not found')
            } else {
                let confirmation = confirm("Please confirm deletion of page",pageName);
                if (confirmation) {
                    ipcRenderer.send('delete:page', projectDetails);
                    toggleDisplay('deletepageform__container');
                } else toggleDisplay('deletepageform__container');
            }
        }

        // Global variables
        let currentProject;
        let curProjectDetails;
        let editorMode = 'html';
        let editors = {};
        let currentEditor;
        let currentPage;
          
        // Recieve
        ipcRenderer.on('load:data', (e, data) => {
            currentProject = data.name;
            curProjectDetails = data;
            let titleCont = document.querySelectorAll('.app-toolbar__title span')[0];
            let projectTitle = document.createTextNode(' - '+currentProject);
            titleCont.style = 'text-transform:capitalize';
            titleCont.appendChild(projectTitle);
            console.log(titleCont)
            // Load html containers for CM instances
            initCMcontainers(curProjectDetails);
            // Load CM instances
            initCMInstances(curProjectDetails);
            // Load tabs
            initTabs(curProjectDetails);
            // Load file content into page editors 
            loadPageContent(curProjectDetails);
            initDictate('textEditor');
            initMenu('menu','.dropdown__btn', '.submenu__btn');
            
        })

        ipcRenderer.on('insert:page', (e, data) => {
            console.log(data);

            //add new CM container
            insertCmContainer(data);
            // add new CM instance
            newCmInstance(data);
            //add new tab
            addNewTab(data);
            //load new page content into new CM instance
            loadNewPageContent(data);
            initDictate('textEditor');
            
            updateCurProjectDetails(data);
            //FINALLY UPDATE curProjectDetails with new stuff
            //'''''''''''''''==========>>>>>>>>><<<<<<<<<<<<<
        });

        ipcRenderer.on('remove:page', (e, data) => {

            //Remove Container
            let container = document.getElementById('page-container-'+data);
            container.parentNode.removeChild(container);
            //Remove tab
            let tab = document.getElementById(data+'-tab__item');
            tab.parentNode.removeChild(tab);
            //Remove page from current project index
            let cpdPageIndex = curProjectDetails.pages.indexOf(data)
            curProjectDetails.pages.splice(cpdPageIndex,1);
            // Remove page from editors instances
            delete editors.data;
            let pageId = curProjectDetails.pages.length > 0 ? curProjectDetails.pages[0] : 'css';
            console.log(pageId)
            setTab('.tab-btn', '#'+pageId+'-tab-btn', '#page-container-'+pageId, pageId);
            
        });

        var map = {}; // You could also use an array
        onkeydown = onkeyup = function(e){
            map[e.keyCode] = e.type == 'keydown';
            /* insert conditional here */
            console.log(map)
        }
        
        
        
    </script>
</html>