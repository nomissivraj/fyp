<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Voice Developer</title>
        
        <link rel="stylesheet" type="text/css" href="node_modules/codemirror/lib/codemirror.css">
        <link rel="stylesheet" type="text/css" href="node_modules/codemirror/theme/lucario.css">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <script src="node_modules/codemirror/lib/codemirror.js"></script>
        <script src="node_modules/codemirror/mode/xml/xml.js"></script>
        <script src="node_modules/codemirror/mode/css/css.js"></script>
        <script src="node_modules/codemirror/mode/javascript/javascript.js"></script>
        <script src="node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
        <script src="node_modules/codemirror/addon/edit/matchtags.js"></script>
        <script src="node_modules/codemirror/addon/edit/closetag.js"></script>
        <script src="node_modules/codemirror/addon/fold/xml-fold.js"></script>
        <script src="scripts/funcs.js"></script>
        <script src="scripts/stt.js"></script>

    </head>
    <body class="text-editor">
        <header class="app-header">
            <div class="app-toolbar">
                <div class="app-toolbar__icon">
                    <img src="img/app-icon-64x64.png" alt="Voice Developer Icon">
                </div>
                <div class="app-toolbar__menu">
                    <ul class="dropdown__menu">
                        <li class="dropdown__item">
                            <button class="dropdown__filebtn" onclick="toggleDisplay('dropdown__filemenu')">File</button>
                            <div id="dropdown__filemenu" style="display: none">
                                <ul class="submenu">
                                    <li>
                                        <button id="savebtn">
                                            <span class="submenu__item-title">Save</span>
                                            <span class="submenu__item-shortcut">Shortcut</span>
                                        </button>
                                    </li>
                                    <li>
                                        <button>Other</button>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                    
                </div>
                <div class="app-toolbar__title">
                    <span>Voice Developer</span>
                </div>
                <div class="app-toolbar__options">
                    <div id="min-btn" class="options__minimise">
                        <img src="img/app-min.svg" width="12px" alt="minimise window icon">
                    </div>
                    <div id="max-btn" class="options__maximise">
                        <img src="img/app-max.svg" width="12px" alt="maximise window icon">
                    </div>
                    <div id="restore-btn" class="options__restore">
                        <img src="img/app-restore.svg" width="12px" alt="restore window icon">
                    </div>
                    <div id="close-btn" class="options__close">
                        <img src="img/app-close.svg" width="12px" alt="close window icon">
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div id="editor" style="z-index: 0">
                <textarea id="editor__text" style="visibility: hidden; min-height: 1px;">

                </textarea>
            </div>
            <button type="button" id="dictate-btn" style="display: none"></button>
        </main>
        
    </body>
    <script>
        require('./scripts/renderer.js');
        const electron = require('electron');
        const {ipcRenderer} = electron;
        const remote = require('electron').remote;
        const app = remote.app;
        const path = require('path');
        const fs = require('file-system');
        const savesPath = path.join(app.getPath('documents'),'Voice Developer Projects','/saves/');
        ipcRenderer.send('ready:text-window');
        process.env['ELECTRON_DISABLE_SECURITY_WARNINGS'] = 'true';
        
        
        let myModeSpec = {
            lineNumbers: true,
            mode: 'xml',
            htmlMode: true,
            theme: 'lucario',
            lineWrapping: true,
            autoCloseTags: true,
            matchTags: true,
        }

        let placeEditor = document.getElementById('editor__text');
        let editor = CodeMirror.fromTextArea(placeEditor, myModeSpec);
        editor.setSize("100%", "calc(100vh - 40px)");

        //Add listeners for menu buttons
        let saveBtn = document.getElementById('savebtn');
        saveBtn.addEventListener('click', ()=>{
            saveChanges(currentProject);
        });

        function saveChanges(currentProject) {
            console.log('saving')
            let changes = editor.getValue()
            let data = {
                name: currentProject,
                file: 'index.html',//this is hardcoded for now (will be context based later)
                content: changes
            }
            ipcRenderer.send('save:file', data)
            toggleDisplay('dropdown__filemenu')
        }
        let currentProject;


        //Recieve
        ipcRenderer.on('load:data', (e, data) => {
            currentProject = data.name;
            // This is hardcoded for index currently... will loop through directory and load all files to array in future (then open in tabs?)
            fs.readFile(savesPath+data.name+'/index.html','utf-8', (err, fileData) => {
                if (err) return console.log(err);
                editor.setValue(fileData)
                editor.focus()
                editor.setCursor(10,0)
                editor.clearHistory();
            });
            //console.log(data);
            
        })

        var map = {}; // You could also use an array
        onkeydown = onkeyup = function(e){
            map[e.keyCode] = e.type == 'keydown';
            /* insert conditional here */
            console.log(map)
        }
        initDictate('textEditor');
    </script>
</html>